<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFAI Enhanced Dashboard - 3-Hour Learning Plan</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 36px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header .subtitle {
            color: #666;
            font-size: 16px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }
        
        .card h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
        }
        
        .stat-big {
            font-size: 48px;
            font-weight: 700;
            color: #667eea;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e0e7ff;
            border-radius: 6px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }
        
        .content-block {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        
        .content-block h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
        }
        
        .content-block .duration {
            color: #667eea;
            font-weight: 600;
            font-size: 14px;
        }
        
        .content-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
            border: 1px solid #e0e7ff;
        }
        
        .content-item strong {
            color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102,126,234,0.3);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        
        .tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            margin: 4px 4px 4px 0;
        }
        
        .tag-youtube { background: #ffe5e5; color: #d32f2f; }
        .tag-papers { background: #e3f2fd; color: #1976d2; }
        .tag-movies { background: #f3e5f5; color: #7b1fa2; }
        .tag-focused { background: #e8f5e9; color: #388e3c; }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .review-prompt {
            background: #fff3e0;
            padding: 20px;
            border-radius: 12px;
            margin-top: 15px;
            border-left: 4px solid #fb8c00;
        }
        
        .review-prompt h4 {
            color: #e65100;
            margin-bottom: 10px;
        }
        
        .review-question {
            margin: 10px 0;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö RFAI Enhanced Dashboard</h1>
            <p class="subtitle">Your 3-Hour Daily Learning Plan</p>
        </div>
        
        <div class="grid">
            <!-- Learning Plan Progress -->
            <div class="card">
                <h2>üìÖ Today's Progress</h2>
                <div class="stat-label">Total Time Target</div>
                <div class="stat-big" id="targetHours">3.0 hrs</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="stat-label" id="actualTime">0.0 hrs completed (0%)</div>
            </div>
            
            <!-- Current Week & Day -->
            <div class="card">
                <h2>üìñ Current Position</h2>
                <div class="stat-label">Week</div>
                <div class="stat-big" id="currentWeek">1</div>
                <div class="stat-label">Day</div>
                <div class="stat-big" id="currentDay">1</div>
                <div id="currentTopic" style="margin-top: 15px; font-size: 16px; color: #667eea;"></div>
            </div>
            
            <!-- Focus Quality -->
            <div class="card">
                <h2>üéØ Focus Quality</h2>
                <div class="stat-label">Current State</div>
                <div class="stat-big" id="focusState">--</div>
                <div class="stat-label" id="focusPercent">0% focused today</div>
            </div>
        </div>
        
        <!-- Time Allocation Pie Chart -->
        <div class="card">
            <h2>‚è∞ Time Allocation Today</h2>
            <div class="chart-container">
                <canvas id="timeAllocationChart"></canvas>
            </div>
        </div>
        
        <!-- Focus Over Time Line Chart -->
        <div class="card">
            <h2>üìà Focus Level Over Time</h2>
            <div class="chart-container">
                <canvas id="focusTimeChart"></canvas>
            </div>
        </div>
        
        <!-- Daily Schedule Content Blocks -->
        <div class="card">
            <h2>üìã Today's Content Schedule</h2>
            <div id="scheduleContent">
                <div class="loading">Loading schedule...</div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card">
            <h2>‚ö° Quick Actions</h2>
            <button class="btn" onclick="refreshDashboard()">üîÑ Refresh Dashboard</button>
            <button class="btn" onclick="viewFullAPI()" style="margin-left: 10px;">üìä View API Data</button>
            <button class="btn" onclick="exportFocusData()" style="margin-left: 10px;">üíæ Export Focus Data</button>
        </div>
    </div>
    
    <script>
        let timeAllocationChart = null;
        let focusTimeChart = null;
        
        async function loadDashboard() {
            try {
                // Load daily stats
                const stats = await fetch('/api/stats/daily').then(r => r.json());
                updateStats(stats);
                
                // Load daily schedule
                const schedule = await fetch('/api/schedule/daily').then(r => r.json());
                updateSchedule(schedule);
                
                // Load activity data for charts
                const activity = await fetch('/api/activity/today').then(r => r.json());
                updateCharts(activity);
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('scheduleContent').innerHTML = 
                    `<div class="error">Error loading data: ${error.message}<br>
                    <small>Make sure API keys are configured in .env file</small></div>`;
            }
        }
        
        function updateStats(stats) {
            if (stats.learning_plan) {
                const plan = stats.learning_plan;
                document.getElementById('targetHours').textContent = `${plan.target_hours} hrs`;
                document.getElementById('currentWeek').textContent = plan.current_week;
                document.getElementById('currentDay').textContent = plan.current_day;
                
                const percent = plan.completion_percent;
                document.getElementById('progressFill').style.width = `${Math.min(percent, 100)}%`;
                document.getElementById('actualTime').textContent = 
                    `${plan.actual_hours} hrs completed (${percent}%)`;
            }
            
            if (stats.focus_breakdown) {
                const total = Object.values(stats.focus_breakdown).reduce((a, b) => a + b, 0);
                const focused = stats.focus_breakdown.FOCUSED || 0;
                const focusPercent = total > 0 ? Math.round((focused / total) * 100) : 0;
                
                document.getElementById('focusPercent').textContent = `${focusPercent}% focused today`;
            }
        }
        
        function updateSchedule(scheduleData) {
            if (scheduleData.error) {
                document.getElementById('scheduleContent').innerHTML = 
                    `<div class="error">${scheduleData.error}<br><small>${scheduleData.note || ''}</small></div>`;
                return;
            }
            
            const schedule = scheduleData.schedule;
            
            // Update current topic
            if (schedule.learning_plan) {
                document.getElementById('currentTopic').textContent = 
                    `üìñ ${schedule.learning_plan.topic}`;
            }
            
            // Display content blocks
            let html = '';
            
            schedule.content_blocks.forEach((block, index) => {
                const icons = {
                    'youtube': 'üé•',
                    'research_papers': 'üìÑ',
                    'artistic_movie': 'üé¨'
                };
                
                html += `
                    <div class="content-block">
                        <h3>${icons[block.type] || 'üìå'} Block ${index + 1}: ${formatBlockType(block.type)}</h3>
                        <div class="duration">‚è±Ô∏è Duration: ${block.duration_hours} hours (${block.duration_minutes} min)</div>
                        <p style="margin: 10px 0; color: #666;">${block.description}</p>
                `;
                
                if (block.type === 'youtube' && block.videos) {
                    html += `<div style="margin-top: 10px;"><strong>üì∫ Recommended Videos:</strong></div>`;
                    block.videos.slice(0, 3).forEach(video => {
                        html += `
                            <div class="content-item">
                                <strong>${video.title}</strong><br>
                                <small>by ${video.channel} ‚Ä¢ ${Math.round(video.duration_seconds / 60)} min</small><br>
                                <a href="${video.url}" target="_blank">‚ñ∂Ô∏è Watch on YouTube</a>
                                <span class="tag tag-youtube">${video.content_type || 'educational'}</span>
                            </div>
                        `;
                    });
                }
                
                if (block.type === 'research_papers' && block.papers) {
                    html += `<div style="margin-top: 10px;"><strong>üìÑ Recommended Papers:</strong></div>`;
                    block.papers.slice(0, 2).forEach(paper => {
                        html += `
                            <div class="content-item">
                                <strong>${paper.title}</strong><br>
                                <small>${paper.authors.slice(0, 2).join(', ')} et al.</small><br>
                                <a href="${paper.url}" target="_blank">üìñ Read on ArXiv</a>
                                <span class="tag tag-papers">${paper.difficulty}</span>
                            </div>
                        `;
                    });
                }
                
                if (block.type === 'artistic_movie' && block.movies) {
                    html += `<div style="margin-top: 10px;"><strong>üé¨ Recommended Films:</strong></div>`;
                    block.movies.slice(0, 2).forEach(movie => {
                        html += `
                            <div class="content-item">
                                <strong>${movie.title}</strong> (${movie.year})<br>
                                <small>Directed by ${movie.director} ‚Ä¢ ‚≠ê ${movie.imdb_rating}/10</small><br>
                                <a href="${movie.url}" target="_blank">üé¨ View on IMDb</a>
                                <span class="tag tag-movies">${movie.artistic_classification || 'artistic'}</span>
                            </div>
                        `;
                    });
                    
                    if (block.post_activity && block.post_activity.required) {
                        html += `
                            <div class="review-prompt">
                                <h4>üìù Post-Viewing Review Required</h4>
                                <p>After watching, please reflect on these questions:</p>
                                ${block.post_activity.questions.slice(0, 3).map(q => 
                                    `<div class="review-question">‚Ä¢ ${q}</div>`
                                ).join('')}
                            </div>
                        `;
                    }
                }
                
                html += '</div>';
            });
            
            document.getElementById('scheduleContent').innerHTML = html;
        }
        
        function updateCharts(activity) {
            // Time Allocation Pie Chart
            const timeData = activity.focus_breakdown || {};
            
            const pieCtx = document.getElementById('timeAllocationChart').getContext('2d');
            if (timeAllocationChart) timeAllocationChart.destroy();
            
            timeAllocationChart = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: ['YouTube', 'Papers', 'Movies', 'Other'],
                    datasets: [{
                        data: [
                            (timeData.YOUTUBE || 0) / 3600,
                            (timeData.PAPERS || 0) / 3600,
                            (timeData.MOVIES || 0) / 3600,
                            (timeData.OTHER || 0) / 3600
                        ],
                        backgroundColor: [
                            '#e57373',
                            '#64b5f6',
                            '#ba68c8',
                            '#9e9e9e'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed.toFixed(2)} hours`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Focus Over Time Line Chart
            const focusStates = activity.focus_states || [];
            const times = focusStates.map(s => new Date(s.timestamp).toLocaleTimeString());
            const focusLevels = focusStates.map(s => {
                const stateMap = {'FOCUSED': 100, 'ACTIVE': 60, 'DISTRACTED': 30, 'INACTIVE': 0};
                return stateMap[s.state] || 50;
            });
            
            const lineCtx = document.getElementById('focusTimeChart').getContext('2d');
            if (focusTimeChart) focusTimeChart.destroy();
            
            focusTimeChart = new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: times.slice(-20), // Last 20 data points
                    datasets: [{
                        label: 'Focus Level',
                        data: focusLevels.slice(-20),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: 0,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    const labels = {0: 'Inactive', 30: 'Distracted', 60: 'Active', 100: 'Focused'};
                                    return labels[value] || '';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        function formatBlockType(type) {
            const names = {
                'youtube': 'YouTube Learning',
                'research_papers': 'Research Papers',
                'artistic_movie': 'Artistic Film'
            };
            return names[type] || type;
        }
        
        function refreshDashboard() {
            loadDashboard();
        }
        
        function viewFullAPI() {
            window.open('/api/status', '_blank');
        }
        
        function exportFocusData() {
            fetch('/api/activity/today')
                .then(r => r.json())
                .then(data => {
                    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `focus-data-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                });
        }
        
        // Load dashboard on page load
        loadDashboard();
        
        // Refresh every 5 minutes
        setInterval(loadDashboard, 5 * 60 * 1000);
    </script>
</body>
</html>
